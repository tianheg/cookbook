---
import Layout from '../../../layouts/Layout.astro';
import { getDB } from '../../../db/client';
import { getRecipeWithDetails } from '../../../db/queries';

const { id } = Astro.params;
const DB = (Astro.locals.runtime as any)?.env?.DB as D1Database | undefined;

if (!DB || !id) {
  return Astro.redirect('/');
}

const db = getDB(DB);
const recipe = await getRecipeWithDetails(db, parseInt(id));

if (!recipe) {
  return Astro.redirect('/404');
}

const difficulties = ['easy', 'medium', 'hard'];
---

<Layout title={`Edit ${recipe.title}`}>
	<div class="min-h-screen bg-base-200">
		<div class="container mx-auto px-4 py-8 max-w-4xl">
			<div class="mb-6">
				<a href={`/recipes/${id}`} class="btn btn-ghost btn-sm">
					‚Üê Back to Recipe
				</a>
			</div>

			<div class="card bg-base-100 shadow-xl">
				<div class="card-body">
					<div class="flex items-center gap-4 mb-6">
						<div class="avatar placeholder">
							<div class="bg-accent text-accent-content rounded-full w-16">
								<span class="text-2xl">‚úèÔ∏è</span>
							</div>
						</div>
						<div>
							<h1 class="text-3xl font-bold">Edit Recipe</h1>
							<p class="text-base-content/70">Update {recipe.title}</p>
						</div>
					</div>

					<form id="recipe-form" class="space-y-6">
						<div class="form-control">
							<label class="label">
								<span class="label-text">Recipe Title</span>
							</label>
							<input
								type="text"
								name="title"
								placeholder="e.g., Spaghetti Carbonara"
								class="input input-bordered"
								value={recipe.title}
								required
								id="recipe-title"
							/>
						</div>

						<div class="form-control">
							<label class="label">
								<span class="label-text">Description</span>
							</label>
							<textarea
								name="description"
								placeholder="Brief description of your recipe"
								class="textarea textarea-bordered"
								rows="2"
							>{recipe.description}</textarea>
						</div>						<div class="card bg-base-200/50">
							<div class="card-body">
								<h3 class="card-title text-base">Recipe Details</h3>
								<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
									<div class="form-control">
										<label class="label">
											<span class="label-text">Prep Time (min)</span>
										</label>
										<input
											type="number"
											name="prepTime"
											placeholder="15"
											class="input input-bordered"
											value={recipe.prepTime}
										/>
									</div>

									<div class="form-control">
										<label class="label">
											<span class="label-text">Cook Time (min)</span>
										</label>
										<input
											type="number"
											name="cookTime"
											placeholder="30"
											class="input input-bordered"
											value={recipe.cookTime}
										/>
									</div>

									<div class="form-control">
										<label class="label">
											<span class="label-text">Servings</span>
										</label>
										<input
											type="number"
											name="servings"
											placeholder="4"
											class="input input-bordered"
											value={recipe.servings}
										/>
									</div>

									<div class="form-control">
										<label class="label">
											<span class="label-text">Difficulty</span>
										</label>
										<select name="difficulty" class="select select-bordered">
											<option value="">Select...</option>
											{difficulties.map(diff => (
												<option value={diff} selected={recipe.difficulty === diff}>{diff}</option>
											))}
										</select>
									</div>
								</div>
							</div>
						</div>

						<div class="form-control">
							<label class="label">
								<span class="label-text">Category</span>
							</label>
							<input
								type="text"
								name="category"
								placeholder="e.g., Italian, Dessert, Indian"
								class="input input-bordered"
								value={recipe.category}
							/>
						</div>

						<div class="form-control">
							<label class="label">
								<span class="label-text">Recipe Image</span>
							</label>
							<div class="flex gap-4">
								<div class="flex-1">
									<label class="input input-bordered flex items-center gap-2 cursor-pointer hover:bg-base-200">
										<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
										</svg>
										<span class="text-sm">Upload Image (JPEG, PNG, WebP)</span>
										<input
											type="file"
											name="imageFile"
											id="imageFile"
											accept="image/jpeg,image/png,image/webp"
											class="hidden"
										/>
									</label>
									<p class="text-xs text-base-content/60 mt-1">Max 5MB</p>
									<div id="upload-status" class="text-xs mt-2"></div>
								</div>
								<div id="image-preview" class="w-20 h-20 rounded-lg bg-base-200 flex items-center justify-center flex-shrink-0 overflow-hidden">
									{recipe.imageUrl ? (
										<img src={recipe.imageUrl} alt="Recipe preview" class="w-full h-full object-cover" />
									) : (
										<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
										</svg>
									)}
								</div>
							</div>
						</div>

						<div class="divider"></div>

						<div class="card bg-base-200/50">
							<div class="card-body">
								<div class="flex justify-between items-center mb-4">
									<h3 class="card-title text-base">
										ü•ò Ingredients
										<span class="badge badge-ghost" id="ingredient-count">{recipe.ingredients.length}</span>
									</h3>
									<button type="button" id="add-ingredient" class="btn btn-accent btn-sm">
										+ Add Ingredient
									</button>
								</div>
						<div id="ingredients-list" class="space-y-3">
							{recipe.ingredients.map((ingredient) => (
								<div class="ingredient-row grid grid-cols-12 gap-2 items-center p-3 bg-base-100 rounded-lg">
									<input 
										type="text" 
										placeholder="Ingredient name" 
										class="input input-bordered input-sm col-span-5" 
										name="ingredient-name[]"
										value={ingredient.name}
										required
									/>
									<input 
										type="text" 
										placeholder="Amount" 
										class="input input-bordered input-sm col-span-3" 
										name="ingredient-amount[]"
										value={ingredient.amount}
										required
									/>
									<input 
										type="text" 
										placeholder="Unit" 
										class="input input-bordered input-sm col-span-3" 
										name="ingredient-unit[]"
										value={ingredient.unit || ''}
									/>
									<button type="button" class="btn btn-ghost btn-sm btn-circle col-span-1 remove-ingredient">
										<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
										</svg>
									</button>
								</div>
							))}
						</div>
					</div>
				</div>

						<div class="divider"></div>

						<div class="card bg-base-200/50">
							<div class="card-body">
								<div class="flex justify-between items-center mb-4">
									<h3 class="card-title text-base">
										üìù Instructions
										<span class="badge badge-ghost" id="instruction-count">{recipe.instructions.length} step{recipe.instructions.length !== 1 ? 's' : ''}</span>
									</h3>
									<button type="button" id="add-instruction" class="btn btn-accent btn-sm">
										+ Add Step
									</button>
								</div>
						<div id="instructions-list" class="space-y-3">
							{recipe.instructions.map((instruction) => (
								<div class="instruction-row flex gap-3 p-3 bg-base-100 rounded-lg">
									<span class="badge badge-primary badge-lg flex-shrink-0">{instruction.stepNumber}</span>
									<textarea 
										placeholder="Describe this step in detail..." 
										class="textarea textarea-bordered flex-1" 
										name="instruction[]"
										rows="2"
										required
									>{instruction.instruction}</textarea>
									<button type="button" class="btn btn-ghost btn-sm btn-circle flex-shrink-0 remove-instruction">
										<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
										</svg>
									</button>
								</div>
							))}
						</div>
					</div>
				</div>

						<div class="divider"></div>

						<div class="sticky bottom-4 pt-4">
							<div class="card bg-base-100 shadow-xl">
								<div class="card-body p-4">
									<div class="flex gap-3">
										<button type="submit" class="btn btn-primary flex-1 btn-lg gap-2">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
											</svg>
											Update Recipe
										</button>
										<a href={`/recipes/${id}`} class="btn btn-ghost btn-lg">
											Cancel
										</a>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</Layout>

<script define:vars={{ recipeId: id }}>
	let ingredientCounter = 0;
	let instructionCounter = 0;

	function updateCounts() {
		const ingredientCount = document.querySelectorAll('.ingredient-row').length;
		const instructionCount = document.querySelectorAll('.instruction-row').length;
		
		const ingredientBadge = document.getElementById('ingredient-count');
		const instructionBadge = document.getElementById('instruction-count');
		
		if (ingredientBadge) ingredientBadge.textContent = ingredientCount;
		if (instructionBadge) {
			instructionBadge.textContent = `${instructionCount} step${instructionCount !== 1 ? 's' : ''}`;
		}
	}

	// Handle image file upload
	document.getElementById('imageFile')?.addEventListener('change', async (e) => {
		const input = e.target;
		const file = input.files?.[0];
		const statusEl = document.getElementById('upload-status');
		const previewEl = document.getElementById('image-preview');

		if (!file) return;

		// Show preview
		const reader = new FileReader();
		reader.onload = (event) => {
			const img = document.createElement('img');
			img.src = event.target.result;
			img.className = 'w-full h-full object-cover';
			previewEl.innerHTML = '';
			previewEl.appendChild(img);
		};
		reader.readAsDataURL(file);

		// Show uploading status
		if (statusEl) {
			statusEl.textContent = 'Uploading...';
			statusEl.className = 'text-xs text-info';
		}

		try {
			const titleInput = document.getElementById('recipe-title');
			const recipeName = titleInput?.value || 'recipe';
			const uploadFormData = new FormData();
			uploadFormData.append('file', file);
			uploadFormData.append('recipeName', recipeName);

			const response = await fetch('/api/upload', {
				method: 'POST',
				body: uploadFormData,
			});

			if (!response.ok) {
				const error = await response.json();
				throw new Error(error.error);
			}

			const result = await response.json();
			// Store the image URL in a hidden field for form submission
			let imageUrlInput = document.querySelector('input[name="imageUrl"]');
			if (!imageUrlInput) {
				imageUrlInput = document.createElement('input');
				imageUrlInput.type = 'hidden';
				imageUrlInput.name = 'imageUrl';
				document.getElementById('recipe-form').appendChild(imageUrlInput);
			}
			imageUrlInput.value = result.imageUrl;

			if (statusEl) {
				statusEl.textContent = 'Upload complete!';
				statusEl.className = 'text-xs text-success';
			}
		} catch (error) {
			console.error('Upload failed:', error);
			const message = error instanceof Error ? error.message : 'Upload failed';
			if (statusEl) {
				statusEl.textContent = `Error: ${message}`;
				statusEl.className = 'text-xs text-error';
			}
		}
	});

	// Add ingredient
	document.getElementById('add-ingredient')?.addEventListener('click', () => {
		const list = document.getElementById('ingredients-list');
		const template = `
			<div class="ingredient-row grid grid-cols-12 gap-2 items-center p-3 bg-base-100 rounded-lg">
				<input type="text" placeholder="Ingredient name" class="input input-bordered input-sm col-span-5" name="ingredient-name[]" required />
				<input type="text" placeholder="Amount" class="input input-bordered input-sm col-span-3" name="ingredient-amount[]" required />
				<input type="text" placeholder="Unit" class="input input-bordered input-sm col-span-3" name="ingredient-unit[]" />
				<button type="button" class="btn btn-ghost btn-sm btn-circle col-span-1 remove-ingredient">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>
		`;
		list?.insertAdjacentHTML('beforeend', template);
		updateCounts();
	});

	// Add instruction
	document.getElementById('add-instruction')?.addEventListener('click', () => {
		const list = document.getElementById('instructions-list');
		const count = list?.querySelectorAll('.instruction-row').length || 0;
		const template = `
			<div class="instruction-row flex gap-3 p-3 bg-base-100 rounded-lg">
				<span class="badge badge-primary badge-lg flex-shrink-0">${count + 1}</span>
				<textarea placeholder="Describe this step in detail..." class="textarea textarea-bordered flex-1" name="instruction[]" rows="2" required></textarea>
				<button type="button" class="btn btn-ghost btn-sm btn-circle flex-shrink-0 remove-instruction">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>
		`;
		list?.insertAdjacentHTML('beforeend', template);
		updateCounts();
	});

	// Remove ingredient
	document.addEventListener('click', (e) => {
		const target = e.target;
		if (target.closest('.remove-ingredient')) {
			const row = target.closest('.ingredient-row');
			if (document.querySelectorAll('.ingredient-row').length > 1) {
				row?.remove();
				updateCounts();
			}
		}
	});

	// Remove instruction
	document.addEventListener('click', (e) => {
		const target = e.target;
		if (target.closest('.remove-instruction')) {
			const row = target.closest('.instruction-row');
			if (document.querySelectorAll('.instruction-row').length > 1) {
				row?.remove();
				// Update step numbers
				document.querySelectorAll('.instruction-row').forEach((row, index) => {
					const badge = row.querySelector('.badge');
					if (badge) badge.textContent = String(index + 1);
				});
				updateCounts();
			}
		}
	});

	// Initialize counts on page load
	updateCounts();

	// Form submission
	document.getElementById('recipe-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const form = e.target;
		const formData = new FormData(form);

		// Parse ingredients
		const ingredientNames = formData.getAll('ingredient-name[]');
		const ingredientAmounts = formData.getAll('ingredient-amount[]');
		const ingredientUnits = formData.getAll('ingredient-unit[]');
		
		const ingredients = ingredientNames.map((name, i) => ({
			name: name,
			amount: ingredientAmounts[i],
			unit: ingredientUnits[i] || null
		})).filter(ing => ing.name && ing.amount);

		// Parse instructions
		const instructions = formData.getAll('instruction[]')
			.map(inst => inst)
			.filter(inst => inst.trim());

		// Build request body with proper field names
		const data = {
			title: formData.get('title'),
			description: formData.get('description') || null,
			prepTime: formData.get('prepTime') ? parseInt(formData.get('prepTime')) : null,
			cookTime: formData.get('cookTime') ? parseInt(formData.get('cookTime')) : null,
			servings: formData.get('servings') ? parseInt(formData.get('servings')) : null,
			difficulty: formData.get('difficulty') || null,
			category: formData.get('category') || null,
			imageUrl: formData.get('imageUrl') || null,
			ingredients,
			instructions
		};

		try {
			const response = await fetch(`/api/recipes/${recipeId}`, {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			});

			if (response.ok) {
				window.location.href = `/recipes/${recipeId}`;
			} else {
				const error = await response.json();
				alert(`Failed to update recipe: ${error.error}`);
			}
		} catch (error) {
			console.error('Error:', error);
			alert('Failed to update recipe');
		}
	});
</script>
