---
import Layout from '../../layouts/Layout.astro';
---

<Layout>
	<div class="container mx-auto px-4 py-8">
		<div class="mb-6">
			<a href="/" class="btn btn-ghost btn-sm">← Back to Recipes</a>
		</div>

		<div class="max-w-2xl mx-auto">
			<h1 class="text-4xl font-bold mb-8">Add New Recipe</h1>

			<form id="recipe-form" class="space-y-6">
				<div class="form-control">
					<label class="label">
						<span class="label-text font-semibold">Recipe Title *</span>
					</label>
					<input 
						type="text" 
						name="title" 
						required 
						class="input input-bordered w-full" 
						placeholder="e.g., Spaghetti Carbonara"
					/>
				</div>

				<div class="form-control">
					<label class="label">
						<span class="label-text font-semibold">Description</span>
					</label>
					<textarea 
						name="description" 
						class="textarea textarea-bordered h-24" 
						placeholder="Brief description of your recipe"
					></textarea>
				</div>

				<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
					<div class="form-control">
						<label class="label">
							<span class="label-text">Prep Time (min)</span>
						</label>
						<input 
							type="number" 
							name="prep_time" 
							class="input input-bordered w-full" 
							placeholder="15"
						/>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text">Cook Time (min)</span>
						</label>
						<input 
							type="number" 
							name="cook_time" 
							class="input input-bordered w-full" 
							placeholder="30"
						/>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text">Servings</span>
						</label>
						<input 
							type="number" 
							name="servings" 
							class="input input-bordered w-full" 
							placeholder="4"
						/>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text">Difficulty</span>
						</label>
						<select name="difficulty" class="select select-bordered w-full">
							<option value="">Select...</option>
							<option value="easy">Easy</option>
							<option value="medium">Medium</option>
							<option value="hard">Hard</option>
						</select>
					</div>
				</div>

				<div class="form-control">
					<label class="label">
						<span class="label-text font-semibold">Category</span>
					</label>
					<input 
						type="text" 
						name="category" 
						class="input input-bordered w-full" 
						placeholder="e.g., Italian, Dessert, Indian"
					/>
				</div>

				<div class="divider"></div>

				<div>
					<div class="flex justify-between items-center mb-4">
						<label class="label">
							<span class="label-text font-semibold text-lg">Ingredients</span>
						</label>
						<button type="button" id="add-ingredient" class="btn btn-sm btn-primary">
							+ Add Ingredient
						</button>
					</div>
					<div id="ingredients-list" class="space-y-3">
						<div class="ingredient-row grid grid-cols-12 gap-2">
							<input 
								type="text" 
								placeholder="Ingredient name" 
								class="input input-bordered col-span-6" 
								name="ingredient-name[]"
							/>
							<input 
								type="text" 
								placeholder="Amount" 
								class="input input-bordered col-span-3" 
								name="ingredient-amount[]"
							/>
							<input 
								type="text" 
								placeholder="Unit" 
								class="input input-bordered col-span-2" 
								name="ingredient-unit[]"
							/>
							<button type="button" class="btn btn-ghost btn-sm col-span-1 remove-ingredient">×</button>
						</div>
					</div>
				</div>

				<div class="divider"></div>

				<div>
					<div class="flex justify-between items-center mb-4">
						<label class="label">
							<span class="label-text font-semibold text-lg">Instructions</span>
						</label>
						<button type="button" id="add-instruction" class="btn btn-sm btn-primary">
							+ Add Step
						</button>
					</div>
					<div id="instructions-list" class="space-y-3">
						<div class="instruction-row flex gap-2">
							<span class="badge badge-primary badge-lg">1</span>
							<textarea 
								placeholder="Describe this step..." 
								class="textarea textarea-bordered flex-1" 
								name="instruction[]"
							></textarea>
							<button type="button" class="btn btn-ghost btn-sm remove-instruction">×</button>
						</div>
					</div>
				</div>

				<div class="divider"></div>

				<div class="flex gap-4">
					<button type="submit" class="btn btn-primary flex-1">
						Save Recipe
					</button>
					<a href="/" class="btn btn-ghost">Cancel</a>
				</div>
			</form>
		</div>
	</div>
</Layout>

<script>
	// Add ingredient
	document.getElementById('add-ingredient')?.addEventListener('click', () => {
		const list = document.getElementById('ingredients-list');
		const template = `
			<div class="ingredient-row grid grid-cols-12 gap-2">
				<input type="text" placeholder="Ingredient name" class="input input-bordered col-span-6" name="ingredient-name[]" />
				<input type="text" placeholder="Amount" class="input input-bordered col-span-3" name="ingredient-amount[]" />
				<input type="text" placeholder="Unit" class="input input-bordered col-span-2" name="ingredient-unit[]" />
				<button type="button" class="btn btn-ghost btn-sm col-span-1 remove-ingredient">×</button>
			</div>
		`;
		list?.insertAdjacentHTML('beforeend', template);
	});

	// Add instruction
	document.getElementById('add-instruction')?.addEventListener('click', () => {
		const list = document.getElementById('instructions-list');
		const count = list?.querySelectorAll('.instruction-row').length || 0;
		const template = `
			<div class="instruction-row flex gap-2">
				<span class="badge badge-primary badge-lg">${count + 1}</span>
				<textarea placeholder="Describe this step..." class="textarea textarea-bordered flex-1" name="instruction[]"></textarea>
				<button type="button" class="btn btn-ghost btn-sm remove-instruction">×</button>
			</div>
		`;
		list?.insertAdjacentHTML('beforeend', template);
	});

	// Remove ingredient
	document.addEventListener('click', (e) => {
		const target = e.target as HTMLElement;
		if (target.classList.contains('remove-ingredient')) {
			const row = target.closest('.ingredient-row');
			if (document.querySelectorAll('.ingredient-row').length > 1) {
				row?.remove();
			}
		}
	});

	// Remove instruction
	document.addEventListener('click', (e) => {
		const target = e.target as HTMLElement;
		if (target.classList.contains('remove-instruction')) {
			const row = target.closest('.instruction-row');
			if (document.querySelectorAll('.instruction-row').length > 1) {
				row?.remove();
				// Update step numbers
				document.querySelectorAll('.instruction-row').forEach((row, index) => {
					const badge = row.querySelector('.badge');
					if (badge) badge.textContent = String(index + 1);
				});
			}
		}
	});

	// Form submission
	document.getElementById('recipe-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const form = e.target as HTMLFormElement;
		const formData = new FormData(form);

		// Parse ingredients
		const ingredientNames = formData.getAll('ingredient-name[]');
		const ingredientAmounts = formData.getAll('ingredient-amount[]');
		const ingredientUnits = formData.getAll('ingredient-unit[]');
		
		const ingredients = ingredientNames.map((name, i) => ({
			name: name as string,
			amount: ingredientAmounts[i] as string,
			unit: ingredientUnits[i] as string || null
		})).filter(ing => ing.name && ing.amount);

		// Parse instructions
		const instructions = formData.getAll('instruction[]')
			.map(inst => inst as string)
			.filter(inst => inst.trim());

		// Build request body
		const data = {
			title: formData.get('title'),
			description: formData.get('description') || null,
			prep_time: formData.get('prep_time') ? parseInt(formData.get('prep_time') as string) : null,
			cook_time: formData.get('cook_time') ? parseInt(formData.get('cook_time') as string) : null,
			servings: formData.get('servings') ? parseInt(formData.get('servings') as string) : null,
			difficulty: formData.get('difficulty') || null,
			category: formData.get('category') || null,
			ingredients,
			instructions
		};

		try {
			const response = await fetch('/api/recipes', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			});

			if (response.ok) {
				const result = await response.json();
				window.location.href = `/recipes/${result.recipeId}`;
			} else {
				alert('Failed to create recipe');
			}
		} catch (error) {
			console.error('Error:', error);
			alert('Failed to create recipe');
		}
	});
</script>
