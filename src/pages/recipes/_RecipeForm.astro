---
import type { Recipe, Ingredient, Instruction } from '../../types';

interface Props {
  recipe?: Recipe & {
    ingredients: Ingredient[];
    instructions: Instruction[];
  };
  isEditing?: boolean;
}

const { recipe, isEditing = false } = Astro.props;
const difficulties = ['easy', 'medium', 'hard'];
const difficultyLabels = {
	easy: 'ç®€å•',
	medium: 'ä¸­ç­‰',
	hard: 'å›°éš¾'
};
const pageTitle = isEditing ? `ç¼–è¾‘ ${recipe?.title}` : 'åˆ›å»ºæ–°é£Ÿè°±';
const submitButtonText = isEditing ? 'æ›´æ–°é£Ÿè°±' : 'ä¿å­˜é£Ÿè°±';
const submitButtonColor = isEditing ? 'from-blue-500 via-blue-600 to-indigo-600 hover:from-blue-600 hover:via-blue-700 hover:to-indigo-700' : 'from-orange-400 via-orange-500 to-amber-500 hover:from-orange-500 hover:via-orange-600 hover:to-amber-600';
const backUrl = isEditing ? `/recipes/${recipe?.id}` : '/';
const formAction = isEditing ? `/api/recipes/${recipe?.id}` : '/api/recipes';
const formMethod = isEditing ? 'PUT' : 'POST';
---

<div class="min-h-screen bg-base-100">
	<div class="container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-5xl">
		<!-- Header -->
		<div class="mb-6 sm:mb-8">
		<a href={backUrl} class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-base-200 hover:bg-base-300 shadow-sm hover:shadow-md transition-all duration-300 group border border-base-300">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-accent group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
			</svg>
			<span class="text-sm font-medium text-base-content">{isEditing ? 'è¿”å›é£Ÿè°±' : 'è¿”å›é£Ÿè°±åˆ—è¡¨'}</span>
		</a>
		</div>

		<!-- Main Form Card -->
		<div class="card bg-base-100 shadow-2xl border border-base-300 hover:shadow-3xl transition-shadow duration-500">
			<div class="card-body p-4 sm:p-6 md:p-10">
				<!-- Page Header -->
				<div class="flex items-center gap-3 sm:gap-6 mb-6 sm:mb-8 pb-6 sm:pb-8 border-b-2 border-base-300">
					<div class="avatar placeholder">
						<div class="bg-gradient-to-br from-primary to-accent text-base-100 rounded-2xl sm:rounded-3xl w-16 h-16 sm:w-24 sm:h-24 shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center">
							<span class="text-3xl sm:text-4xl">{isEditing ? 'âœï¸' : 'âœ¨'}</span>
						</div>
					</div>
					<div class="flex-1">
				<h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-primary leading-tight mb-2">{isEditing ? 'ç¼–è¾‘é£Ÿè°±' : 'åˆ›å»ºæ–°é£Ÿè°±'}</h1>
				<p class="text-base-content/70 text-sm sm:text-base md:text-lg font-medium">{isEditing ? 'æ›´æ–°ä½ ç¾å‘³çš„é£Ÿè°± ğŸ“' : 'ä¸ä¸–ç•Œåˆ†äº«ä½ çš„çƒ¹é¥ªæ°ä½œ'}</p>
					</div>
				</div>

				<form id="recipe-form" class="space-y-6">
				<!-- åŸºæœ¬ä¿¡æ¯ -->
				<div class="space-y-5">
					<div class="flex items-center gap-3 mb-6">
						<div class="p-2 bg-gradient-to-br from-orange-100 to-amber-100 rounded-xl">
							<span class="text-2xl sm:text-3xl">ğŸ“‹</span>
						</div>
						<h2 class="text-xl sm:text-2xl font-bold text-base-content">åŸºæœ¬ä¿¡æ¯</h2>
					</div>
					
					<div class="form-control">
						<label class="label">
							<span class="label-text font-semibold text-base text-base-content flex items-center gap-2">
								é£Ÿè°±åç§°
								<span class="badge badge-sm bg-orange-100 text-orange-600 border-0">å¿…å¡«</span>
							</span>
						</label>
						<input
							type="text"
							name="title"
							placeholder="ä¾‹å¦‚ï¼Œæ„å¤§åˆ©é¢æ¡"
							class="input input-bordered input-md sm:input-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all border-orange-200 hover:border-orange-300 bg-base-100 text-base-content"
							value={recipe?.title || ''}
							required
							id="recipe-title"
						/>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text font-semibold text-base text-base-content">æè¿°</span>
							<span class="label-text-alt text-base-content/50">å¯é€‰</span>
						</label>
						<textarea
							name="description"
							placeholder="å‘Šè¯‰æˆ‘ä»¬è¿™é“ç¾å¦™çš„èœè‚´... æ˜¯ä»€ä¹ˆè®©å®ƒç‰¹åˆ«ï¼Ÿ"
							class="textarea textarea-bordered textarea-md sm:textarea-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all min-h-[100px] sm:min-h-[120px] border-orange-200 hover:border-orange-300 bg-base-100 text-base-content resize-none"
							rows="4"
						>{recipe?.description || ''}</textarea>
					</div>
				</div>

				<div class="divider my-8">
					<div class="w-2 h-2 rounded-full bg-orange-300"></div>
				</div>

				<!-- Recipe Details -->
				<div class="space-y-5">
					<div class="flex items-center gap-3 mb-6">
						<div class="p-2 bg-gradient-to-br from-orange-100 to-amber-100 rounded-xl">
							<span class="text-2xl sm:text-3xl">â±ï¸</span>
						</div>
						<h2 class="text-xl sm:text-2xl font-bold text-base-content">é£Ÿè°±è¯¦æƒ…</h2>
					</div>
					
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
					<div class="form-control">
						<label class="label">
							<span class="label-text font-semibold text-sm text-base-content flex items-center gap-1.5">
								<span>â²ï¸</span> å‡†å¤‡æ—¶é—´ (åˆ†é’Ÿ)
							</span>
						</label>
						<input
							type="number"
							name="prepTime"
							placeholder="15"
							class="input input-bordered focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all border-orange-200 hover:border-orange-300 bg-base-100 text-base-content"
							value={recipe?.prepTime || ''}
							min="0"
						/>
					</div>
					<div class="form-control">
						<label class="label">
							<span class="label-text font-semibold text-sm text-base-content flex items-center gap-1.5">
								<span>ğŸ³</span> çƒ¹é¥ªæ—¶é—´ (åˆ†é’Ÿ)
							</span>
						</label>
						<input
							type="number"
							name="cookTime"
							placeholder="30"
							class="input input-bordered focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all border-orange-200 hover:border-orange-300 bg-base-100 text-base-content"
							value={recipe?.cookTime || ''}
							min="0"
						/>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text font-semibold text-sm text-base-content flex items-center gap-1.5">
								<span>ğŸ½ï¸</span> ä»½é‡
							</span>
						</label>
						<input
							type="number"
							name="servings"
							placeholder="4"
							class="input input-bordered focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all border-orange-200 hover:border-orange-300 bg-base-100 text-base-content"
							value={recipe?.servings || ''}
							min="1"
						/>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text font-semibold text-sm text-base-content flex items-center gap-1.5">
								<span>ğŸ“Š</span> éš¾åº¦
							</span>
						</label>
						<select name="difficulty" class="select select-bordered focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all border-orange-200 hover:border-orange-300 bg-base-100 text-base-content">
							<option value="">é€‰æ‹©...</option>
							{difficulties.map(diff => (
								<option value={diff} selected={recipe?.difficulty === diff}>
									{difficultyLabels[diff as keyof typeof difficultyLabels]}
								</option>
							))}
						</select>
					</div>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text font-semibold text-sm text-base-content flex items-center gap-1.5">
								<span>ğŸ·ï¸</span> ç±»åˆ«
							</span>
						</label>
						<input
							type="text"
							name="category"
							placeholder="ä¾‹å¦‚ï¼Œæ„å¤§åˆ©èœï¼Œç”œç‚¹ï¼Œç´ é£Ÿ"
							class="input input-bordered focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all border-orange-200 hover:border-orange-300 bg-base-100 text-base-content"
							value={recipe?.category || ''}
						/>
					</div>
				</div>

				<div class="divider my-8">
					<div class="w-2 h-2 rounded-full bg-orange-300"></div>
				</div>

				<!-- é£Ÿè°±å›¾ç‰‡ -->
				<div class="space-y-5">
					<div class="flex items-center gap-3 mb-6">
						<div class="p-2 bg-gradient-to-br from-orange-100 to-amber-100 rounded-xl">
							<span class="text-2xl sm:text-3xl">ğŸ–¼ï¸</span>
						</div>
						<h2 class="text-xl sm:text-2xl font-bold text-base-content">é£Ÿè°±å›¾ç‰‡</h2>
					</div>
					
					<div class="flex flex-col md:flex-row gap-6 items-start">
						<div class="flex-1 w-full">
								<label for="imageFile" class="relative flex flex-col items-center justify-center border-2 border-dashed border-orange-300 rounded-2xl p-8 cursor-pointer transition-all duration-300 hover:border-orange-400 hover:bg-orange-50/50 group bg-base-100 dark:hover:bg-base-200/50 h-48">
								<div class="absolute inset-0 bg-gradient-to-br from-orange-400/0 to-amber-400/0 group-hover:from-orange-400/5 group-hover:to-amber-400/5 rounded-2xl transition-all duration-300"></div>
								<div class="relative z-10 flex flex-col items-center gap-3">
									<div class="p-4 bg-orange-100 rounded-full group-hover:bg-orange-200 transition-colors">
										<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-orange-500 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
										</svg>
									</div>
									<div class="text-center">
										<p class="font-semibold text-base text-base-content group-hover:text-orange-600 transition-colors">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»æµè§ˆ</p>
										<p class="text-sm text-base-content/60 mt-1">JPEG, PNG, WebP â€¢ æœ€å¤§ 5MB</p>
									</div>
								</div>
								<input
									type="file"
									name="imageFile"
									id="imageFile"
									accept="image/jpeg,image/png,image/webp"
									class="hidden"
								/>
							</label>
							<div id="upload-status" class="text-sm mt-4 text-center font-medium"></div>
						</div>
						
						<div class="flex flex-col items-center gap-3">
							<div id="image-preview" class="w-48 h-48 rounded-2xl bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 flex items-center justify-center overflow-hidden shadow-lg transition-all hover:shadow-xl hover:scale-105 duration-300">
								{recipe?.imageUrl ? (
									<img src={recipe.imageUrl} alt="Recipe preview" class="w-full h-full object-cover" />
								) : (
									<svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 text-orange-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
									</svg>
								)}
							</div>
							<span class="text-xs text-base-content/60 font-medium">é¢„è§ˆ</span>
						</div>
					</div>
				</div>

				<div class="divider my-8">
					<div class="w-2 h-2 rounded-full bg-orange-300"></div>
				</div>

			<!-- Ingredients Section -->
			<div class="space-y-4">
				<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-6">
					<div class="flex items-center gap-3">
						<span class="text-2xl sm:text-3xl">ğŸ¥˜</span>
						<h2 class="text-xl sm:text-2xl font-bold text-base-content">é…æ–™</h2>
							<span class="badge bg-gradient-to-r from-amber-500 to-amber-600 text-white badge-md sm:badge-lg shadow-md font-semibold" id="ingredient-count">{recipe?.ingredients.length || 0}</span>
						</div>
						<button type="button" id="add-ingredient" class="btn bg-gradient-to-r from-amber-400 to-amber-500 hover:from-amber-500 hover:to-amber-600 text-white border-0 btn-sm gap-2 shadow-md hover:shadow-lg transition-all hover:scale-105 w-full sm:w-auto">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
							</svg>
							æ·»åŠ é…æ–™
						</button>
					</div>
					
					<div id="ingredients-list" class="space-y-2 w-full">
						{recipe?.ingredients && recipe.ingredients.length > 0 ? (
							recipe.ingredients.map((ingredient) => (
								<div class="ingredient-row bg-base-100 rounded-lg p-3 sm:p-4 shadow-xs hover:shadow-sm transition-all border-l-4 border-amber-400">
									<div class="grid grid-cols-12 gap-3 items-center">
										<div class="col-span-12 sm:col-span-5">
											<input 
												type="text" 
												placeholder="é…æ–™åç§° *" 
												class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" 
												name="ingredient-name[]"
												value={ingredient.name}
												required
											/>
										</div>
										<div class="col-span-5 sm:col-span-3">
											<input 
												type="text" 
												placeholder="é‡ * " 
												class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" 
												name="ingredient-amount[]"
												value={ingredient.amount}
												required
											/>
										</div>
										<div class="col-span-5 sm:col-span-3">
											<input 
												type="text" 
												placeholder="å•ä½" 
												class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" 
												name="ingredient-unit[]"
												value={ingredient.unit || ''}
											/>
										</div>
										<div class="col-span-2 sm:col-span-1 flex justify-center">
											<button type="button" class="btn btn-ghost btn-sm btn-circle hover:btn-error transition-all remove-ingredient">
												<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
												</svg>
											</button>
										</div>
									</div>
								</div>
							))
						) : (
							<div class="ingredient-row bg-base-100 rounded-lg p-3 sm:p-4 shadow-xs hover:shadow-sm transition-all border-l-4 border-amber-400">
								<div class="grid grid-cols-12 gap-3 items-center">
									<div class="col-span-12 sm:col-span-5">
										<input 
											type="text" 
											placeholder="é…æ–™åç§° *" 
											class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" 
											name="ingredient-name[]"
											required
										/>
									</div>
									<div class="col-span-5 sm:col-span-3">
										<input 
											type="text" 
											placeholder="æ•°é‡ *" 
											class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" 
											name="ingredient-amount[]"
											required
										/>
									</div>
									<div class="col-span-5 sm:col-span-3">
										<input 
											type="text" 
											placeholder="å•ä½" 
											class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" 
											name="ingredient-unit[]"
										/>
									</div>
									<div class="col-span-2 sm:col-span-1 flex justify-center">
										<button type="button" class="btn btn-ghost btn-sm btn-circle hover:btn-error transition-all remove-ingredient">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
											</svg>
										</button>
									</div>
								</div>
							</div>
						)}
					</div>
				</div>

				<div class="divider my-8">
					<div class="w-2 h-2 rounded-full bg-orange-300"></div>
				</div>

			<!-- Instructions Section -->
			<div class="space-y-4">
				<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-6">
					<div class="flex items-center gap-3">
					<span class="text-2xl sm:text-3xl">ğŸ“</span>
					<h2 class="text-xl sm:text-2xl font-bold text-base-content">åšæ³•</h2>
						<span class="badge bg-gradient-to-r from-orange-500 to-orange-600 text-white badge-md sm:badge-lg shadow-md font-semibold" id="instruction-count">{recipe?.instructions.length || 0} æ­¥{recipe?.instructions.length !== 1 ? 'éª¤' : ''}</span>
						</div>
						<button type="button" id="add-instruction" class="btn bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white border-0 btn-sm gap-2 shadow-md hover:shadow-lg transition-all hover:scale-105 w-full sm:w-auto">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
							</svg>
							æ·»åŠ æ­¥éª¤
						</button>
					</div>
					
					<div id="instructions-list" class="space-y-2 w-full">
						{recipe?.instructions && recipe.instructions.length > 0 ? (
							recipe.instructions.map((instruction) => (
								<div class="instruction-row bg-base-100 rounded-lg p-3 sm:p-4 shadow-xs hover:shadow-sm transition-all border-l-4 border-orange-400">
									<div class="flex gap-4 items-start">
										<div class="badge badge-lg h-10 w-10 bg-orange-100 text-orange-600 flex-shrink-0 text-base font-bold border-0">{instruction.stepNumber}</div>
										<textarea 
											placeholder="è¯¦ç»†æè¿°æ­¤æ­¥éª¤..." 
											class="textarea textarea-bordered flex-1 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all min-h-[100px] border-orange-200 hover:border-orange-300 bg-base-100 text-base-content resize-none" 
											name="instruction[]"
											rows="3"
											required
										>{instruction.instruction}</textarea>
										<button type="button" class="btn btn-ghost btn-sm btn-circle flex-shrink-0 hover:btn-error transition-all remove-instruction">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
											</svg>
										</button>
									</div>
								</div>
							))
						) : (
							<div class="instruction-row bg-base-100 rounded-lg p-3 sm:p-4 shadow-xs hover:shadow-sm transition-all border-l-4 border-orange-400">
								<div class="flex gap-4 items-start">
									<div class="badge badge-lg h-10 w-10 bg-orange-100 text-orange-600 flex-shrink-0 text-base font-bold border-0">1</div>
									<textarea 
										placeholder="è¯¦ç»†æè¿°æ­¤æ­¥éª¤..." 
										class="textarea textarea-bordered flex-1 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all min-h-[100px] border-orange-200 hover:border-orange-300 bg-base-100 text-base-content resize-none" 
										name="instruction[]"
										rows="3"
										required
									></textarea>
									<button type="button" class="btn btn-ghost btn-sm btn-circle flex-shrink-0 hover:btn-error transition-all remove-instruction">
										<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
										</svg>
									</button>
								</div>
							</div>
						)}
					</div>
				</div>

				<div class="divider my-8"></div>

				<!-- Action Buttons -->
				<div class="flex flex-col sm:flex-row gap-3 sm:gap-4 sticky bottom-3 sm:bottom-6 bg-gradient-to-r from-white via-orange-50/30 to-amber-50/30 p-5 sm:p-6 rounded-2xl shadow-2xl border-2 border-orange-200/60 backdrop-blur-sm">
					<button type="submit" class={`btn bg-gradient-to-r ${submitButtonColor} text-white border-0 flex-1 btn-md sm:btn-lg gap-2 sm:gap-3 shadow-lg hover:shadow-2xl transition-all hover:scale-[1.02] font-semibold`}>
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
						</svg>
						{submitButtonText}
					</button>
					<a href={backUrl} class="btn btn-ghost btn-md sm:btn-lg hover:bg-orange-100/50 transition-all">
						å–æ¶ˆ
					</a>
				</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script define:vars={{ isEditing, recipeId: recipe?.id }}>
	let ingredientCounter = 0;
	let instructionCounter = 0;

	function updateCounts() {
		const ingredientCount = document.querySelectorAll('.ingredient-row').length;
		const instructionCount = document.querySelectorAll('.instruction-row').length;
		
		const ingredientBadge = document.getElementById('ingredient-count');
		const instructionBadge = document.getElementById('instruction-count');
		
		if (ingredientBadge) ingredientBadge.textContent = ingredientCount;
		if (instructionBadge) {
			instructionBadge.textContent = `${instructionCount} æ­¥${instructionCount !== 1 ? 'éª¤' : ''}`;
		}
	}

	// Handle image file upload
	document.getElementById('imageFile')?.addEventListener('change', async (e) => {
		const input = e.target;
		const file = input.files?.[0];
		const statusEl = document.getElementById('upload-status');
		const previewEl = document.getElementById('image-preview');

		if (!file) return;

		// Show preview
		const reader = new FileReader();
		reader.onload = (event) => {
			const img = document.createElement('img');
			const result = event.target?.result;
			img.src = result;
			img.className = 'w-full h-full object-cover rounded-2xl';
			if (previewEl) {
				previewEl.innerHTML = '';
				previewEl.appendChild(img);
			}
		};
		reader.readAsDataURL(file);

		// Show uploading status
		if (statusEl) {
			statusEl.textContent = 'â³ ä¸Šä¼ ä¸­...';
			statusEl.className = 'text-sm text-info font-medium';
		}

		try {
			const titleInput = document.getElementById('recipe-title');
			const recipeName = titleInput?.value || 'recipe';
			const uploadFormData = new FormData();
			uploadFormData.append('file', file);
			uploadFormData.append('recipeName', recipeName);

			const response = await fetch('/api/upload', {
				method: 'POST',
				body: uploadFormData,
			});

			if (!response.ok) {
				const error = await response.json();
				throw new Error(error.error);
			}

			const result = await response.json();
			// Store the image URL in a hidden field for form submission
			let imageUrlInput = document.querySelector('input[name="imageUrl"]');
			if (!imageUrlInput) {
				imageUrlInput = document.createElement('input');
				imageUrlInput.type = 'hidden';
				imageUrlInput.name = 'imageUrl';
				const form = document.getElementById('recipe-form');
				if (form) form.appendChild(imageUrlInput);
			}
			imageUrlInput.value = result.imageUrl;

			if (statusEl) {
				statusEl.textContent = 'âœ… ä¸Šä¼ å®Œæˆï¼';
				statusEl.className = 'text-sm text-success font-semibold';
			}
		} catch (error) {
			console.error('Upload failed:', error);
			const message = error instanceof Error ? error.message : 'Upload failed';
			if (statusEl) {
				statusEl.textContent = `âŒ é”™è¯¯: ${message}`;
				statusEl.className = 'text-sm text-error font-medium';
			}
		}
	});

	// Add ingredient
	document.getElementById('add-ingredient')?.addEventListener('click', () => {
		const list = document.getElementById('ingredients-list');
		const template = `
			<div class="ingredient-row bg-base-100 rounded-lg p-3 sm:p-4 shadow-xs hover:shadow-sm transition-all border-l-4 border-amber-400">
				<div class="grid grid-cols-12 gap-3 items-center">
					<div class="col-span-12 sm:col-span-5">
						<input type="text" placeholder="é…æ–™åç§° *" class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" name="ingredient-name[]" required />
					</div>
					<div class="col-span-5 sm:col-span-3">
						<input type="text" placeholder="æ•°é‡ *" class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" name="ingredient-amount[]" required />
					</div>
					<div class="col-span-5 sm:col-span-3">
						<input type="text" placeholder="å•ä½" class="input input-bordered input-sm w-full focus:border-amber-400 focus:ring-2 focus:ring-amber-200 transition-all border-amber-200 hover:border-amber-300 bg-base-100 text-base-content" name="ingredient-unit[]" />
					</div>
					<div class="col-span-2 sm:col-span-1 flex justify-center">
						<button type="button" class="btn btn-ghost btn-sm btn-circle hover:btn-error transition-all remove-ingredient">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
							</svg>
						</button>
					</div>
				</div>
			</div>
		`;
		list?.insertAdjacentHTML('beforeend', template);
		updateCounts();
	});

	// Add instruction
	document.getElementById('add-instruction')?.addEventListener('click', () => {
		const list = document.getElementById('instructions-list');
		const count = list?.querySelectorAll('.instruction-row').length || 0;
		const template = `
			<div class="instruction-row bg-base-100 rounded-lg p-3 sm:p-4 shadow-xs hover:shadow-sm transition-all border-l-4 border-orange-400">
				<div class="flex gap-4 items-start">
					<div class="badge badge-lg h-10 w-10 bg-orange-100 text-orange-600 flex-shrink-0 text-base font-bold border-0">${count + 1}</div>
					<textarea placeholder="è¯¦ç»†æè¿°æ­¤æ­¥éª¤..." class="textarea textarea-bordered flex-1 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all min-h-[100px] border-orange-200 hover:border-orange-300 bg-base-100 text-base-content resize-none" name="instruction[]" rows="3" required></textarea>
					<button type="button" class="btn btn-ghost btn-sm btn-circle flex-shrink-0 hover:btn-error transition-all remove-instruction">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
						</svg>
					</button>
				</div>
			</div>
		`;
		list?.insertAdjacentHTML('beforeend', template);
		updateCounts();
	});

	// Remove ingredient
	document.addEventListener('click', (e) => {
		const target = e.target;
		if (target.closest('.remove-ingredient')) {
			const row = target.closest('.ingredient-row');
			if (document.querySelectorAll('.ingredient-row').length > 1) {
				row?.remove();
				updateCounts();
			}
		}
	});

	// Remove instruction
	document.addEventListener('click', (e) => {
		const target = e.target;
		if (target.closest('.remove-instruction')) {
			const row = target.closest('.instruction-row');
			if (document.querySelectorAll('.instruction-row').length > 1) {
				row?.remove();
					// Update step numbers
				document.querySelectorAll('.instruction-row').forEach((row, index) => {
					const badge = row.querySelector('.badge');
					if (badge) badge.textContent = String(index + 1);
				});
				updateCounts();
			}
		}
	});

	// Initialize counts on page load
	updateCounts();

	// Form submission
	document.getElementById('recipe-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const form = e.target;
		const formData = new FormData(form);

		// Parse ingredients
		const ingredientNames = formData.getAll('ingredient-name[]');
		const ingredientAmounts = formData.getAll('ingredient-amount[]');
		const ingredientUnits = formData.getAll('ingredient-unit[]');
		
		const ingredients = ingredientNames.map((name, i) => ({
			name: name,
			amount: ingredientAmounts[i],
			unit: ingredientUnits[i] || null
		})).filter(ing => ing.name && ing.amount);

		// Parse instructions
		const instructions = formData.getAll('instruction[]')
			.map(inst => inst)
			.filter(inst => inst.trim());

		// Build request body with proper field names
		const data = {
			title: formData.get('title'),
			description: formData.get('description') || null,
			prepTime: formData.get('prepTime') ? parseInt(formData.get('prepTime')) : null,
			cookTime: formData.get('cookTime') ? parseInt(formData.get('cookTime')) : null,
			servings: formData.get('servings') ? parseInt(formData.get('servings')) : null,
			difficulty: formData.get('difficulty') || null,
			category: formData.get('category') || null,
			imageUrl: formData.get('imageUrl') || null,
			ingredients,
			instructions
		};

		try {
			const method = isEditing ? 'PUT' : 'POST';
			const endpoint = isEditing ? `/api/recipes/${recipeId}` : '/api/recipes';
			
			const response = await fetch(endpoint, {
				method: method,
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			});

			if (response.ok) {
				const result = await response.json();
				const redirectUrl = isEditing ? `/recipes/${recipeId}` : `/recipes/${result.recipeId}`;
				window.location.href = redirectUrl;
			} else {
				const error = await response.json();
				alert(`æ— æ³•${isEditing ? 'æ›´æ–°' : 'åˆ›å»º'}é£Ÿè°±: ${error.error}`);
			}
		} catch (error) {
			console.error('Error:', error);
			alert(`æ— æ³•${isEditing ? 'æ›´æ–°' : 'åˆ›å»º'}é£Ÿè°±`);
		}
	});
</script>
