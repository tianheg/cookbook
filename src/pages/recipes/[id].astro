---
import Layout from '../../layouts/Layout.astro';
import { getDB } from '../../db/client';
import { getRecipeWithDetails } from '../../db/queries';

const { id } = Astro.params;
const DB = (Astro.locals.runtime as any)?.env?.DB as D1Database | undefined;

if (!DB || !id) {
  return Astro.redirect('/');
}

const db = getDB(DB);
const recipe = await getRecipeWithDetails(db, parseInt(id));

if (!recipe) {
  return Astro.redirect('/404');
}

const totalTime = (recipe.prepTime || 0) + (recipe.cookTime || 0);
---

<Layout title={recipe.title}>
	<div class="container mx-auto px-4 py-8">
		<div class="mb-6 flex gap-2">
			<a href="/" class="btn btn-ghost btn-sm gap-2 hover:gap-3 transition-all">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Back to Recipes
			</a>
		</div>

		<article class="max-w-4xl mx-auto">
			<div class="card bg-base-100 shadow-xl">
				{recipe.imageUrl && (
					<figure class="h-64 md:h-96">
						<img src={recipe.imageUrl} alt={recipe.title} class="w-full h-full object-cover" />
					</figure>
				)}
				
				<div class="card-body">
					<h1 class="text-4xl font-bold mb-4">{recipe.title}</h1>
					
					{recipe.description && (
						<p class="text-lg mb-6">{recipe.description}</p>
					)}

				<div class="flex flex-wrap gap-4 mb-6">
					{recipe.category && (
						<div class="badge badge-lg bg-orange-50 text-orange-600 border-orange-100">{recipe.category}</div>
					)}
					{recipe.difficulty && (
						<div class={`badge badge-lg ${
							recipe.difficulty === 'easy' ? 'bg-green-100 text-green-700 border-green-200' :
							recipe.difficulty === 'medium' ? 'bg-amber-100 text-amber-700 border-amber-200' :
							'bg-rose-100 text-rose-700 border-rose-200'
						}`}>
								{recipe.difficulty}
							</div>
						)}
						{recipe.prepTime && (
							<div class="flex items-center gap-2">
								<span class="font-semibold">Prep:</span>
								<span>{recipe.prepTime} min</span>
							</div>
						)}
						{recipe.cookTime && (
							<div class="flex items-center gap-2">
								<span class="font-semibold">Cook:</span>
								<span>{recipe.cookTime} min</span>
							</div>
						)}
						{totalTime > 0 && (
							<div class="flex items-center gap-2">
								<span class="font-semibold">Total:</span>
								<span>{totalTime} min</span>
							</div>
						)}
						{recipe.servings && (
							<div class="flex items-center gap-2">
								<span class="font-semibold">Servings:</span>
								<span>{recipe.servings}</span>
							</div>
						)}
					</div>

					<div class="divider"></div>

					<div class="grid md:grid-cols-2 gap-8">
						<div>
							<h2 class="text-2xl font-bold mb-4">Ingredients</h2>
							<ul class="space-y-2">
								{recipe.ingredients.map((ingredient) => (
									<li class="flex items-start">
										<span class="mr-2">â€¢</span>
										<span>
											{ingredient.amount} {ingredient.unit} {ingredient.name}
										</span>
									</li>
								))}
							</ul>
						</div>

						<div>
						<h2 class="text-2xl font-bold mb-4">Instructions</h2>
						<ol class="space-y-4">
							{recipe.instructions.map((instruction) => (
								<li class="flex items-start gap-3">
									<span class="badge bg-orange-400 text-white badge-lg">{instruction.stepNumber}</span>
										<span class="flex-1">{instruction.instruction}</span>
									</li>
								))}
							</ol>
						</div>
					</div>

					<div class="divider"></div>

					<div class="card-actions justify-between">
						<a href={`/recipes/${id}/edit`} class="btn bg-orange-400 hover:bg-orange-500 text-white border-0 gap-2">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
							</svg>
							Edit Recipe
						</a>
						<button 
							class="btn bg-rose-100 hover:bg-rose-200 text-rose-700 border-rose-200 gap-2"
							onclick={`if(confirm('Are you sure you want to delete this recipe?')) {{
									fetch('/api/recipes/${id}', { method: 'DELETE' })
										.then(res => res.ok ? window.location.href = '/' : alert('Failed to delete recipe'))
										.catch(err => alert('Failed to delete recipe'))
								}`}
							>
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
								</svg>
								Delete Recipe
							</button>
					</div>
				</div>
			</div>
		</article>
	</div>
</Layout>
