---
import Layout from '../../layouts/Layout.astro';
import type { RecipeWithDetails } from '../../types';

const { id } = Astro.params;
const DB = Astro.locals.runtime?.env?.DB as D1Database | undefined;

if (!DB) {
  return Astro.redirect('/');
}

// Fetch recipe
const recipe = await DB.prepare('SELECT * FROM recipes WHERE id = ?').bind(id).first<RecipeWithDetails>();

if (!recipe) {
  return Astro.redirect('/404');
}

// Fetch ingredients
const { results: ingredients } = await DB.prepare(
  'SELECT * FROM ingredients WHERE recipe_id = ? ORDER BY sort_order'
).bind(id).all();

// Fetch instructions
const { results: instructions } = await DB.prepare(
  'SELECT * FROM instructions WHERE recipe_id = ? ORDER BY step_number'
).bind(id).all();
---

<Layout>
	<div class="container mx-auto px-4 py-8">
		<div class="mb-6">
			<a href="/" class="btn btn-ghost btn-sm">← Back to Recipes</a>
		</div>

		<article class="max-w-4xl mx-auto">
			<div class="card bg-base-100 shadow-xl">
				{recipe.image_url && (
					<figure class="h-64 md:h-96">
						<img src={recipe.image_url} alt={recipe.title} class="w-full h-full object-cover" />
					</figure>
				)}
				
				<div class="card-body">
					<h1 class="text-4xl font-bold mb-4">{recipe.title}</h1>
					
					{recipe.description && (
						<p class="text-lg mb-6">{recipe.description}</p>
					)}

					<div class="flex flex-wrap gap-4 mb-6">
						{recipe.category && (
							<div class="badge badge-lg badge-outline">{recipe.category}</div>
						)}
						{recipe.difficulty && (
							<div class={`badge badge-lg ${
								recipe.difficulty === 'easy' ? 'badge-success' :
								recipe.difficulty === 'medium' ? 'badge-warning' :
								'badge-error'
							}`}>
								{recipe.difficulty}
							</div>
						)}
						{recipe.prep_time && (
							<div class="flex items-center gap-2">
								<span class="font-semibold">Prep:</span>
								<span>{recipe.prep_time} min</span>
							</div>
						)}
						{recipe.cook_time && (
							<div class="flex items-center gap-2">
								<span class="font-semibold">Cook:</span>
								<span>{recipe.cook_time} min</span>
							</div>
						)}
						{recipe.servings && (
							<div class="flex items-center gap-2">
								<span class="font-semibold">Servings:</span>
								<span>{recipe.servings}</span>
							</div>
						)}
					</div>

					<div class="divider"></div>

					<div class="grid md:grid-cols-2 gap-8">
						<div>
							<h2 class="text-2xl font-bold mb-4">Ingredients</h2>
							<ul class="space-y-2">
								{ingredients && ingredients.map((ingredient: any) => (
									<li class="flex items-start">
										<span class="mr-2">•</span>
										<span>
											{ingredient.amount} {ingredient.unit} {ingredient.name}
										</span>
									</li>
								))}
							</ul>
						</div>

						<div>
							<h2 class="text-2xl font-bold mb-4">Instructions</h2>
							<ol class="space-y-4">
								{instructions && instructions.map((instruction: any) => (
									<li class="flex items-start gap-3">
										<span class="badge badge-primary badge-lg">{instruction.step_number}</span>
										<span class="flex-1">{instruction.instruction}</span>
									</li>
								))}
							</ol>
						</div>
					</div>

					<div class="divider"></div>

					<div class="card-actions justify-end">
						<button 
							class="btn btn-error btn-outline"
							onclick={`if(confirm('Are you sure you want to delete this recipe?')) {
								fetch('/api/recipes/${id}', { method: 'DELETE' })
									.then(() => window.location.href = '/')
									.catch(err => alert('Failed to delete recipe'))
							}`}
						>
							Delete Recipe
						</button>
					</div>
				</div>
			</div>
		</article>
	</div>
</Layout>
